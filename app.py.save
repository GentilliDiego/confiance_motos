from flask import Flask, render_template, request, redirect, url_for
import sqlite3
from pathlib import Path

app = Flask(__name__)
DB_PATH = Path(__file__).with_name("estoque.db")

# ───────────── BANCO ─────────────
def init_db():
    with sqlite3.connect(DB_PATH) as conn:
            # tabela de motos (estoque)
                    conn.execute("""
                                CREATE TABLE IF NOT EXISTS motos (
                                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                                                modelo TEXT, chassi TEXT, placa TEXT,
                                                                                cor TEXT, ano TEXT, origem TEXT,
                                                                                                preco_aquisicao REAL, preco_venda REAL
                                                                                                            );
                                                                                                                    """)
                                                                                                                            # tabela de leads (vendas)
                                                                                                                                    conn.execute("""
                                                                                                                                                CREATE TABLE IF NOT EXISTS leads (
                                                                                                                                                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                                                                                                                                                                nome TEXT, telefone TEXT, cpf TEXT,
                                                                                                                                                                                                data_nasc TEXT, produto_id INTEGER,
                                                                                                                                                                                                                temperatura TEXT, observacoes TEXT,
                                                                                                                                                                                                                                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                    """)

                                                                                                                                                                                                                                                    # ───────────── helpers ESTOQUE ─────────────
                                                                                                                                                                                                                                                    def estoque_all():
                                                                                                                                                                                                                                                        with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                cur = conn.execute("""
                                                                                                                                                                                                                                                                            SELECT id, modelo, chassi, placa, ano, cor, preco_venda
                                                                                                                                                                                                                                                                                        FROM motos ORDER BY id DESC
                                                                                                                                                                                                                                                                                                """)
                                                                                                                                                                                                                                                                                                        return cur.fetchall()

                                                                                                                                                                                                                                                                                                        def moto_get(mid):
                                                                                                                                                                                                                                                                                                            with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                    cur = conn.execute("SELECT * FROM motos WHERE id=?", (mid,))
                                                                                                                                                                                                                                                                                                                            row = cur.fetchone()
                                                                                                                                                                                                                                                                                                                                    return dict(zip([c[0] for c in cur.description], row)) if row else None

                                                                                                                                                                                                                                                                                                                                    def moto_insert(d):
                                                                                                                                                                                                                                                                                                                                        with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                conn.execute("""
                                                                                                                                                                                                                                                                                                                                                            INSERT INTO motos
                                                                                                                                                                                                                                                                                                                                                                        (modelo,chassi,placa,cor,ano,origem,preco_aquisicao,preco_venda)
                                                                                                                                                                                                                                                                                                                                                                                    VALUES (:modelo,:chassi,:placa,:cor,:ano,:origem,
                                                                                                                                                                                                                                                                                                                                                                                                        :preco_aquisicao,:preco_venda)
                                                                                                                                                                                                                                                                                                                                                                                                                """, d)

                                                                                                                                                                                                                                                                                                                                                                                                                def moto_update(mid, d):
                                                                                                                                                                                                                                                                                                                                                                                                                    with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                            conn.execute("""
                                                                                                                                                                                                                                                                                                                                                                                                                                        UPDATE motos SET
                                                                                                                                                                                                                                                                                                                                                                                                                                                      modelo=:modelo, chassi=:chassi, placa=:placa,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cor=:cor, ano=:ano, origem=:origem,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  preco_aquisicao=:preco_aquisicao, preco_venda=:preco_venda
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              WHERE id=:id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      """, {**d, "id": mid})

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def moto_delete(mid):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  conn.execute("DELETE FROM motos WHERE id=?", (mid,))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def motos_dropdown():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return conn.execute("SELECT id, modelo FROM motos ORDER BY modelo").fetchall()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # ───────────── helpers LEADS ─────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def leads_all():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return conn.execute("""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      SELECT l.id, l.nome, l.telefone, l.temperatura,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         l.created_at, m.modelo
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     FROM leads l
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 LEFT JOIN motos m ON m.id = l.produto_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ORDER BY l.created_at DESC
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     """).fetchall()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     def lead_get(lid):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 cur = conn.execute("SELECT * FROM leads WHERE id=?", (lid,))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         row = cur.fetchone()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return dict(zip([c[0] for c in cur.description], row)) if row else None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 def lead_insert(d):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             conn.execute("""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         INSERT INTO leads
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (nome, telefone, cpf, data_nasc, produto_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  temperatura, observacoes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              VALUES (:nome,:telefone,:cpf,:data_nasc,:produto_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  :temperatura,:observacoes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          """, d)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          def lead_update(lid, d):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              with sqlite3.connect(DB_PATH) as conn:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      conn.execute("""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  UPDATE leads SET
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                nome=:nome, telefone=:telefone, cpf=:cpf,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              data_nasc=:data_nasc, produto_id=:produto_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            temperatura=:temperatura, observacoes=:observacoes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        WHERE id=:id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """, {**d, "id": lid})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
